# Invariantes y Reglas de Negocio

En el contexto del Domain-Driven Design (DDD) y la arquitectura hexagonal, los conceptos de invariantes y reglas de negocio son fundamentales para mantener la consistencia y validez del modelo de dominio. Ambos aseguran que las entidades, agregados y otros componentes del núcleo de la aplicación cumplan siempre con las condiciones necesarias para representar correctamente la realidad del negocio.

	•	Invariantes: Son restricciones o condiciones que deben cumplirse siempre en el estado de una entidad o agregado para que su estado sea válido. Si se rompe una invariante, la entidad ya no cumple con las reglas del negocio y se encuentra en un estado inválido.
	•	Reglas de Negocio: Son políticas o procesos que definen cómo debe comportarse el sistema para satisfacer las necesidades del negocio. Estas reglas pueden aplicarse a nivel de entidad, agregado o en servicios de dominio.

Ambos conceptos ayudan a encapsular y proteger la lógica de negocio dentro del dominio, garantizando que el sistema mantenga su integridad en todo momento.

A. ¿Qué son las Invariantes?

Las invariantes son reglas estrictas que aseguran que el estado de una entidad o agregado sea siempre consistente y válido. Una invariante es una condición que debe cumplirse en todo momento para que la entidad o agregado represente correctamente la realidad del negocio. Si una invariante no se cumple, significa que el estado de la entidad o del agregado es inválido y no refleja un estado permitido por el dominio.

Características de las Invariantes

	1.	Condiciones Permanentes:
	•	Las invariantes deben cumplirse en todo momento, tanto al crear una entidad o agregar un elemento como al actualizar su estado.
	•	Por ejemplo, una entidad CuentaBancaria podría tener la invariante de que el saldo nunca sea negativo.
	2.	Encapsuladas dentro de Entidades y Agregados:
	•	Las invariantes deben protegerse y verificarse dentro de las propias entidades y agregados, para evitar que el estado se vuelva inconsistente desde fuera.
	•	Al encapsular las invariantes, nos aseguramos de que todas las reglas y restricciones de negocio se respeten y se apliquen en un solo lugar.
	3.	Automatizan la Consistencia:
	•	Al definir invariantes claras y hacerlas cumplir en las entidades y agregados, podemos garantizar que el estado siempre sea válido y consistente sin depender de verificaciones adicionales en otras capas.

Ejemplo de Invariantes

Imaginemos una entidad Pedido en una aplicación de e-commerce. Un Pedido podría tener las siguientes invariantes:

	•	Debe tener al menos una Línea de Pedido para poder ser procesado.
	•	El estado del pedido debe ser coherente; por ejemplo, un pedido no puede pasar de “Pendiente” a “Entregado” sin antes estar en “Enviado”.

Código Ejemplo:

class Pedido {
    private lineas: LineaPedido[] = [];
    private estado: string;

    constructor() {
        this.estado = 'Pendiente';
    }

    public agregarLinea(linea: LineaPedido): void {
        if (this.estado !== 'Pendiente') {
            throw new Error('No se pueden agregar líneas a un pedido en estado procesado');
        }
        this.lineas.push(linea);
    }

    public procesarPedido(): void {
        if (this.lineas.length === 0) {
            throw new Error('El pedido debe tener al menos una línea para ser procesado');
        }
        this.estado = 'Procesado';
    }

    public enviarPedido(): void {
        if (this.estado !== 'Procesado') {
            throw new Error('El pedido debe estar en estado Procesado para ser enviado');
        }
        this.estado = 'Enviado';
    }

    public entregarPedido(): void {
        if (this.estado !== 'Enviado') {
            throw new Error('El pedido debe estar en estado Enviado para ser entregado');
        }
        this.estado = 'Entregado';
    }
}

En este ejemplo:

	•	La entidad Pedido encapsula sus invariantes y asegura que su estado sea siempre válido.
	•	Si se intenta procesar un pedido sin líneas de pedido o cambiar su estado sin respetar el flujo adecuado, se lanzará un error.

B. ¿Qué son las Reglas de Negocio?

Las reglas de negocio son directrices o políticas que definen el comportamiento esperado del sistema para satisfacer los requerimientos del negocio. Las reglas de negocio pueden aplicarse a diferentes niveles en el dominio:

	1.	Reglas de Entidad o Agregado:
	•	Son reglas que se aplican dentro de una entidad o agregado en particular y que se refieren directamente a sus propiedades y comportamiento.
	•	Por ejemplo, una CuentaBancaria no puede tener un saldo negativo.
	2.	Reglas de Dominio Transversales:
	•	Son reglas que afectan a varias entidades y que definen comportamientos o políticas que abarcan todo el dominio.
	•	Por ejemplo, una regla de negocio en una aplicación de e-commerce podría indicar que los productos de ciertos proveedores tienen un descuento especial.
	3.	Reglas en los Servicios de Dominio:
	•	Cuando una regla de negocio no pertenece a una entidad específica o afecta a varias entidades en coordinación, se puede implementar en un servicio de dominio.
	•	Por ejemplo, un servicio CalculadorDeDescuentos podría aplicar diferentes tipos de descuentos dependiendo del tipo de cliente y del monto de la compra.

C. Ejemplo de Reglas de Negocio en Diferentes Niveles

	1.	Regla de Negocio en una Entidad
	•	En una entidad CuentaBancaria, una regla de negocio puede ser que el saldo no puede ser negativo.

class CuentaBancaria {
    private saldo: number;

    constructor(saldoInicial: number) {
        if (saldoInicial < 0) {
            throw new Error('El saldo inicial no puede ser negativo');
        }
        this.saldo = saldoInicial;
    }

    public retirar(monto: number): void {
        if (monto < 0) throw new Error('El monto a retirar no puede ser negativo');
        if (this.saldo - monto < 0) {
            throw new Error('Fondos insuficientes');
        }
        this.saldo -= monto;
    }
}

En este ejemplo, la regla de negocio de que el saldo no puede ser negativo está implementada directamente en la entidad, asegurando que siempre se respete.

	2.	Regla de Negocio en un Servicio de Dominio
	•	Un servicio CalculadorDeInteres podría calcular el interés para una cuenta bancaria basándose en el saldo, el tipo de cuenta y otras políticas de negocio.

class CalculadorDeInteres {
    public calcularInteres(cuenta: CuentaBancaria): number {
        if (cuenta.esCuentaVIP()) {
            return cuenta.getSaldo() * 0.05; // 5% de interés para cuentas VIP
        }
        return cuenta.getSaldo() * 0.02; // 2% de interés para otras cuentas
    }
}

En este ejemplo, la regla de negocio que define el cálculo de interés según el tipo de cuenta está encapsulada en un servicio de dominio, que no pertenece directamente a ninguna entidad.

D. Ventajas de Definir Invariantes y Reglas de Negocio Claramente

	1.	Consistencia y Validez del Estado
	•	Al definir y hacer cumplir invariantes, aseguramos que las entidades y agregados permanezcan en un estado consistente y válido en todo momento.
	•	Esto reduce la posibilidad de errores y facilita el mantenimiento del sistema.
	2.	Centralización de la Lógica de Negocio
	•	Las reglas de negocio encapsuladas dentro del dominio centralizan toda la lógica relevante, evitando su dispersión en distintas partes del sistema.
	•	Esto facilita la modificación y actualización de reglas, ya que solo deben cambiarse en un lugar.
	3.	Facilidad de Pruebas y Verificación
	•	La encapsulación de invariantes y reglas de negocio en entidades y servicios de dominio permite probar fácilmente la lógica de negocio, validando que se cumplen las condiciones necesarias en cada operación.
	•	Esto mejora la calidad del sistema y permite detectar errores en una fase temprana.
	4.	Protección contra Estados Inválidos
	•	Al definir invariantes y reglas de negocio, evitamos que el sistema entre en estados inválidos que podrían causar problemas o inconsistencias en el negocio.
	•	La validación interna de los datos asegura que el sistema refleje siempre un estado válido y seguro.
	5.	Facilidad de Evolución del Dominio
	•	Con las reglas de negocio y las invariantes bien definidas, cualquier cambio o evolución en el dominio puede implementarse de manera controlada y predecible.
	•	Las reglas encapsuladas facilitan el crecimiento del sistema, manteniendo la integridad de la lógica de negocio.

Por supuesto. Aquí tienes la continuación desde E. Buenas Prácticas al Implementar Invariantes y Reglas de Negocio.

E. Buenas Prácticas al Implementar Invariantes y Reglas de Negocio

	1.	Definir las Invariantes en el Momento de Creación
	•	Las invariantes deben definirse y validarse desde el momento en que se crea la entidad o el agregado, asegurando que el estado inicial ya sea válido. De este modo, se evita que la entidad entre en un estado inconsistente desde el principio.
	•	Ejemplo: Si un Pedido debe tener al menos una línea para ser válido, esta condición debe comprobarse al crear o modificar el pedido.
	2.	Encapsular las Reglas en el Nivel Correcto
	•	Las reglas de negocio deben implementarse en el nivel adecuado según su naturaleza. Si la regla aplica a una sola entidad, debe encapsularse en esa entidad. Si afecta a varias entidades o al dominio general, entonces debe implementarse en un agregado o en un servicio de dominio.
	•	Ejemplo: La regla de que una cuenta no puede tener un saldo negativo debe estar en la entidad CuentaBancaria. En cambio, la regla para calcular intereses en función del tipo de cuenta puede estar en un servicio CalculadorDeInteres.
	3.	Evitar la Duplicación de Reglas de Negocio
	•	Las reglas de negocio deben centralizarse para evitar inconsistencias. Duplicar reglas en múltiples lugares del código puede llevar a que las reglas se apliquen de manera inconsistente o incorrecta.
	•	Ejemplo: Si la lógica para calcular descuentos se encuentra en múltiples lugares, puede producirse un desajuste entre cálculos. Encapsular esta lógica en un solo servicio de dominio asegura que el cálculo sea coherente en toda la aplicación.
	4.	Usar Excepciones para Manejar Violaciones de Invariantes
	•	Si se intenta realizar una operación que viola una invariante, se debe lanzar una excepción para evitar que la entidad entre en un estado inválido.
	•	Ejemplo: En una entidad Producto, si se intenta reducir el stock a un valor negativo, se debería lanzar una excepción para impedir que se realice esta operación.
	5.	Definir Métodos Expresivos que Respeten las Reglas de Negocio
	•	Los métodos en las entidades y servicios deben ser expresivos y claros en cuanto a su propósito, asegurando que respeten las invariantes y reglas de negocio.
	•	Ejemplo: En lugar de exponer un método setEstado en una entidad Pedido, es mejor tener métodos específicos como procesarPedido, enviarPedido, etc., que respeten el flujo de estados permitido.
	6.	Utilizar Pruebas para Validar las Invariantes y Reglas de Negocio
	•	Las pruebas son esenciales para verificar que las invariantes y reglas de negocio se apliquen correctamente en todas las operaciones. Las pruebas unitarias deben comprobar que las reglas e invariantes se respeten en diversas condiciones.
	•	Ejemplo: Probar que una entidad CuentaBancaria no permite realizar retiros si el saldo es insuficiente y que el sistema lanza la excepción esperada en estos casos.
	7.	Considerar las Invariantes en el Diseño de Agregados
	•	Al diseñar agregados, es importante definir claramente las invariantes que afectan al agregado completo y asegurarse de que la entidad raíz del agregado controle todas las operaciones que puedan modificar su estado.
	•	Ejemplo: En un agregado Pedido con varias LíneaPedido, la entidad raíz Pedido debe garantizar que el pedido solo pueda marcarse como “procesado” si todas las líneas cumplen las reglas de negocio necesarias.

Resumen

Las invariantes y reglas de negocio son herramientas poderosas para asegurar que el sistema mantenga la consistencia y la integridad en el dominio. Al encapsular estas reglas dentro de las entidades, agregados y servicios de dominio, podemos garantizar que la lógica de negocio se aplique de manera coherente y que el estado del sistema sea siempre válido. Seguir estas buenas prácticas permite construir un sistema robusto, fácil de mantener y que refleje fielmente los requisitos del negocio.